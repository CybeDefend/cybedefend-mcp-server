// src/tools/updateVulnerability.ts
import axios from "axios";
import { forwardAuth } from "../utils/forwardAuth.js";
import { API_BASE } from "../utils/apiBase.js";
import { resolveProjectId } from "../utils/projectId.js";

export const updateVulnerabilityTool = {
    name: "update_vulnerability",
    description:
        "Update a vulnerability's status, priority, or add a comment. If projectId is omitted, uses CYBEDEFEND_PROJECT_ID.",
    inputSchema: {
        type: "object",
        properties: {
            projectId: { type: "string", description: "Optional. Defaults to CYBEDEFEND_PROJECT_ID." },
            vulnerabilityId: { type: "string", description: "UUID of the vulnerability." },
            status: {
                type: "string",
                enum: ["to_verify", "not_exploitable", "proposed_not_exploitable", "resolved", "confirmed", "ignored"],
                description: "New status.",
            },
            priority: {
                type: "string",
                enum: ["critical_urgent", "urgent", "normal", "low", "very_low"],
                description: "New priority.",
            },
            comment: { type: "string", description: "Comment (max 512 chars)." },
        },
        required: ["vulnerabilityId"],
    },
    async run(params: any, clientHeaders: Record<string, string | undefined>) {
        const { projectId, vulnerabilityId, ...body } = params;
        const pid = resolveProjectId(projectId);
        const res = await axios.patch(
            `${API_BASE}/project/${pid}/results/${vulnerabilityId}`,
            body,
            { headers: { ...forwardAuth(clientHeaders), "User-Agent": "cybedefend-mcp/1.0" }, timeout: 15_000 },
        );
        return res.data;
    },
};
